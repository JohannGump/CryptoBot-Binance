apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-container
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: api-container
  strategy: {}
  template:
    metadata:
      labels:
        app: api-container
    spec:
      containers:
        - image: johanngump/cryptobot-web-api:test-1
          name: web-api
          ports:
            - containerPort: 8000
              hostPort: 8000
              protocol: TCP
          resources: {}
          env:
            - name: MYSQL_DATABASE_PREDICTIONS
              value: klines_history
            - name: MYSQL_HOST_PREDICTIONS
              value: db
            - name: MYSQL_PASSWORD_PREDICTIONS
              value: password
            - name: MYSQL_USER_PREDICTIONS
              value: root
      restartPolicy: Always
status: {}
---
# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: app
#   namespace: default
# spec:
#   replicas: 1
#   selector:
#     matchLabels:
#       app: app
#   strategy:
#     type: Recreate
#   template:
#     metadata:
#       labels:
#         app: app
#     spec:
#       containers:
#         - env:
#             - name: MYSQL_DATABASE_KLINES
#               value: klines_history
#             - name: MYSQL_DATABASE_PREDICTIONS
#               value: klines_history
#             - name: MYSQL_HOST_KLINES
#               value: db
#             - name: MYSQL_HOST_PREDICTIONS
#               value: db
#             - name: MYSQL_PASSWORD_KLINES
#               value: password
#             - name: MYSQL_PASSWORD_PREDICTIONS
#               value: password
#             - name: MYSQL_USER_KLINES
#               value: root
#             - name: MYSQL_USER_PREDICTIONS
#               value: root
#             - name: PREDICT_SERVER_HOST
#               value: c-predict:8501
#           image: johanngump/requester-app:test-4
#           name: c-script
#           resources: {}
#           volumeMounts:
#             - mountPath: /app/data
#               name: preprocessing-data
#       restartPolicy: Always
#       volumes:
#         - name: preprocessing-data
#           persistentVolumeClaim:
#             claimName: preprocessing-data
# status: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: data
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: data
  strategy: {}
  template:
    metadata:
      labels:
        app: data
    spec:
      containers:
        - env:
            - name: KLINESDB_DBNAME
              value: klines_history
            - name: KLINESDB_HOST
              value: db
            - name: KLINESDB_PASSWORD
              value: password
            - name: KLINESDB_USER
              value: root
            - name: KLINES_MAX_RECORDS_PER_SYTS
              value: "5000"
          image: johanngump/cryptobot-data:test-1
          name: historical-data
          resources: {}
      restartPolicy: Always
status: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: c-predict
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: c-predict
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: c-predict
    spec:
      containers:
        - args:
            - --model_config_file=/models/models.config
            - --model_config_file_poll_wait_seconds=60
          image: tensorflow/serving:2.13.0
          name: c-predict
          ports:
            - containerPort: 8501
              hostPort: 8501
              protocol: TCP
          resources: {}
          volumeMounts:
            - mountPath: /models
              name: model-fit
      restartPolicy: Always
      volumes:
        - name: model-fit
          persistentVolumeClaim:
            claimName: model-fit
status: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: model-fit
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: model-fit
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: model-fit
    spec:
      containers:
        - env:
            - name: KLINESDB_DBNAME
              value: klines_history
            - name: KLINESDB_HOST
              value: db
            - name: KLINESDB_PASSWORD
              value: password
            - name: KLINESDB_USER
              value: root
          image: johanngump/cryptobot-model:test-1
          name: model-fit
          resources: {}
          volumeMounts:
            - mountPath: /src/model_fit
              name: model-fit
      restartPolicy: Always
      volumes:
        - name: model-fit
          persistentVolumeClaim:
            claimName: model-fit
status: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: db
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: db
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: db
    spec:
      containers:
        - env:
            - name: MYSQL_DATABASE
              value: klines_history
            - name: MYSQL_ROOT_PASSWORD
              value: password
          image: mysql:latest
          livenessProbe:
            exec:
              command:
                - mysqladmin
                - ping
                - -h
                - localhost
            failureThreshold: 5
            periodSeconds: 10
            timeoutSeconds: 5
          name: db
          ports:
            - containerPort: 3306
              hostPort: 3306
              protocol: TCP
          resources: {}
          securityContext:
            capabilities:
              add:
                - SYS_NICE
          volumeMounts:
            - mountPath: /var/lib/mysql
              name: klines-data
      restartPolicy: Always
      volumes:
        - name: klines-data
          persistentVolumeClaim:
            claimName: klines-data
status: {}
